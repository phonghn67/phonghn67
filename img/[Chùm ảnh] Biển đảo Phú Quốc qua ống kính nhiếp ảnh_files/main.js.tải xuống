var VNT_BLOG = VNT_BLOG || {};

VNT_BLOG = {
    init: function () {
        VNT_BLOG.globalJS();
        // VNT_BLOG.trackingJS();
        VNT_BLOG.copyCoupon();
        VNT_BLOG.addHotelBookmark();
        VNT_BLOG.removeHotelBookmark();
        VNT_BLOG.checkBookmarkHotel();
        VNT_BLOG.tabBookmark();
        VNT_BLOG.vntripLogin();
        VNT_BLOG.vntripLogout();
        VNT_BLOG.sidebarCallbox();
        VNT_BLOG.slideOwlCarousel();
        VNT_BLOG.clickInsertComment();

        $(document).ready(function () {
            let user = localStorage.getItem('__amplify__user');
            user = JSON.parse(user);

            if (user) {
                if (user?.data) {
                    $('#login_btn').hide();
                    $('.nav-account').show();
                    $('#user_fullname').text(user.data.full_name);
                } else {
                    VNT_BLOG.vntripGoogleOneTap();
                }
            } else {
                VNT_BLOG.vntripGoogleOneTap();
            }

        });
    },

    globalJS: function () {
        $('.btnLogin').click(function () {
            $('#loginBox').addClass('open');
            $('#registerBox').removeClass('open');
            $('#passBox').removeClass('open');
        });

        $('.btnRegister').click(function () {
            $('#loginBox').removeClass('open');
            $('#registerBox').addClass('open');
            $('#passBox').removeClass('open');
        });

        $('.btnPass').click(function () {
            $('#loginBox').removeClass('open');
            $('#registerBox').removeClass('open');
            $('#passBox').addClass('open');
        });

        $('.formLogin__backdrop, .formLogin__close').click(function () {
            $('.formLogin').removeClass('open');
        });

        $('.acount-loged').click(function () {
            $('.membership-regLog').slideToggle(200);
        });

        $(".schema-faq-question").on("click", function () {
            if ($(this).hasClass("active")) {
                $(this).removeClass("active");
                $(this)
                    .siblings(".schema-faq-answer")
                    .slideUp(200);
            } else {
                $(this)
                $(".schema-faq-question").removeClass("active");
                $(this).addClass("active");
                $(".schema-faq-answer").slideUp(200);
                $(this)
                    .siblings(".schema-faq-answer")
                    .slideDown(200);
            }
        });

    },

    trackingJS: function () {
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-134441135-1', 'auto');

        window.onload = function () {
            ga('send', 'pageview');
            setTimeout(function () {
                (function (w, d, s, l, i) {
                    w[l] = w[l] || [];
                    w[l].push({
                        'gtm.start':
                            new Date().getTime(), event: 'gtm.js'
                    });
                    var f = d.getElementsByTagName(s)[0],
                        j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : '';
                    j.async = true;
                    j.src =
                        'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
                    f.parentNode.insertBefore(j, f);
                })(window, document, 'script', 'dataLayer', 'GTM-P7TQ2Q');
            }, 3000);
        }
    },

    copyCoupon: function () {
        $(document).on("click", ".copy_coupon", function (e) {
            let coupon = e.currentTarget.getAttribute('data-coupon');

            VNT_BLOG.setClipboard(coupon);
            alert(`Mã ${coupon} đã được sao chép!`);
        });
    },

    setClipboard: function (value) {
        var tempInput = document.createElement("input");
        tempInput.style = "position: absolute; left: -1000px; top: -1000px";
        tempInput.value = value;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);
    },

    /**
     * Click bookmark hotel
     */
    addHotelBookmark: function () {
        $(document).on("click", ".add_hotel_favourite", function (e) {
            e.preventDefault();
            $this = $(this);
            let hotel_id = e.currentTarget.getAttribute('data-id');

            let arr = VNT_BLOG.getCookie('hotel_bookmark') || [];

            if (arr.length > 0) {
                arr = JSON.parse(arr);
            }

            if (!arr.includes(hotel_id)) {
                let hotel_ids = arr;
                hotel_ids.unshift(hotel_id);

                $this.removeClass('add_hotel_favourite');
                $this.addClass('btn_checked').addClass('remove_hotel_favourite');
                $this.html(`<svg width='13' height='10' viewBox='0 0 13 10' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M11.6953 0.265625C11.75 0.210938 11.8047 0.15625 11.9141 0.15625C11.9961 0.15625 12.0781 0.210938 12.1328 0.265625L12.4609 0.566406C12.5156 0.648438 12.543 0.730469 12.543 0.8125C12.543 0.921875 12.5156 0.976562 12.4609 1.03125L4.25781 9.23438C4.17578 9.31641 4.09375 9.34375 4.01172 9.34375C3.92969 9.34375 3.84766 9.31641 3.79297 9.23438L0.539062 5.98047C0.484375 5.92578 0.457031 5.87109 0.457031 5.76172C0.457031 5.67969 0.484375 5.59766 0.539062 5.51562L0.867188 5.21484C0.921875 5.16016 0.976562 5.10547 1.08594 5.10547C1.16797 5.10547 1.25 5.16016 1.30469 5.21484L4.01172 7.92188L11.6953 0.265625Z' fill='#262626'></path></svg>`);

                VNT_BLOG.setCookie('hotel_bookmark', JSON.stringify(hotel_ids), 30);
                VNT_BLOG.setCountBookmark();

                // Show header
                $(".headerM").css('display', 'flex').css('position', 'fixed');
            }

        });
    },
    removeHotelBookmark: function () {
        $(document).on("click", ".remove_hotel_favourite", function (e) {
            e.preventDefault();
            $this = $(this);
            let hotel_id = e.currentTarget.getAttribute('data-id');
            let arr = VNT_BLOG.getCookie('hotel_bookmark') || [];

            if (arr.length > 0) {
                arr = JSON.parse(arr);
            }

            arr.splice(arr.indexOf(hotel_id), 1);

            $this.addClass('add_hotel_favourite');
            $this.removeClass('btn_checked').removeClass('remove_hotel_favourite');
            $this.html(`<svg width='12' height='16' viewBox='0 0 12 16' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M9.84375 0.875C10.2246 0.875 10.5469 1.02148 10.8398 1.28516C11.1035 1.57812 11.25 1.90039 11.25 2.28125V15.875L5.625 12.5938L0 15.875V2.28125C0 1.90039 0.117188 1.57812 0.410156 1.28516C0.673828 1.02148 0.996094 0.875 1.40625 0.875H9.84375ZM10.3125 14.2344V2.28125C10.3125 2.16406 10.2539 2.04688 10.166 1.95898C10.0781 1.87109 9.96094 1.8125 9.84375 1.8125H1.40625C1.25977 1.8125 1.14258 1.87109 1.05469 1.95898C0.966797 2.04688 0.9375 2.16406 0.9375 2.28125V14.2344L5.625 11.5098L10.3125 14.2344Z' fill='white'></path></svg><span>Quan tâm</span>`);

            VNT_BLOG.setCookie('hotel_bookmark', JSON.stringify(arr), 30);
            VNT_BLOG.setCountBookmark();

            // Show header
            $(".headerM").css('display', 'flex').css('position', 'fixed');
        });
    },
    setCountBookmark: function () {
        let arr_hotel = VNT_BLOG.getCookie('hotel_bookmark') || [];
        let arr_coupon = VNT_BLOG.getCookie('coupon_bookmark') || [];

        if (arr_hotel.length > 0) {
            arr_hotel = JSON.parse(arr_hotel);
        }

        if (arr_coupon.length > 0) {
            arr_coupon = JSON.parse(arr_coupon);
        }

        let total_count = arr_hotel.length + arr_coupon.length;

        $('.badge__count').text(total_count);
    },
    checkBookmarkHotel() {
        let hotel_ids = VNT_BLOG.getCookie('hotel_bookmark') || [];
        if (hotel_ids.length > 0) {
            hotel_ids = JSON.parse(hotel_ids);
        }
        hotel_ids.forEach(function (value) {
            $(`[data-id=${value}]`).removeClass('add_hotel_favourite').addClass('btn_checked remove_hotel_favourite').html(`<svg width="13" height="10" viewBox="0 0 13 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.6953 0.265625C11.75 0.210938 11.8047 0.15625 11.9141 0.15625C11.9961 0.15625 12.0781 0.210938 12.1328 0.265625L12.4609 0.566406C12.5156 0.648438 12.543 0.730469 12.543 0.8125C12.543 0.921875 12.5156 0.976562 12.4609 1.03125L4.25781 9.23438C4.17578 9.31641 4.09375 9.34375 4.01172 9.34375C3.92969 9.34375 3.84766 9.31641 3.79297 9.23438L0.539062 5.98047C0.484375 5.92578 0.457031 5.87109 0.457031 5.76172C0.457031 5.67969 0.484375 5.59766 0.539062 5.51562L0.867188 5.21484C0.921875 5.16016 0.976562 5.10547 1.08594 5.10547C1.16797 5.10547 1.25 5.16016 1.30469 5.21484L4.01172 7.92188L11.6953 0.265625Z" fill="#262626"></path></svg>`)
        });
    },

    setCookie: function (key, cvalue, exdays) {
        var d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        var expires = "expires=" + d.toGMTString();
        document.cookie = key + "=" + cvalue + ";" + expires + ";path=/";
    },
    getCookie: function (key) {
        var name = key + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    },

    postRating: function (e) {
        $('.star-post-rating').click(function (e) {
            let star_value = e.currentTarget.getAttribute('data-value');
            let post_id = $('#post_id').val();

            VNT_BLOG.ajaxPostRating(star_value, post_id);
        });
    },
    ajaxPostRating(star_value, post_id) {
        $.ajax({
            url: vntrip.ajax_url,
            data: {
                'action': 'rating_post',
                'star': star_value,
                'post_id': post_id,
            },
            beforeSend: function () {
                $('.rateStar').hide();
                $('#post_rating_loading').show();
            },
            success: function (data) {
                $('#post_rating_loading').hide();
                $('#post_rating_smile').show();
                $('.rate-title').text("Cảm ơn bạn đã đánh giá!");
                setTimeout(function () {
                    $('#btn_rating').hide();
                    $('.starPopup').removeClass('open');
                }, 1500);
            },
            error: function (e) {
                console.log('error: ', e);
            }
        });
    },

    vntripLogin: function () {
        $('#submit_login').click(function () {
            let login_email = $('#login_email').val();
            let login_password = $('#login_password').val();
            let $this = $(this);

            $.ajax({
                url: 'https://micro-services.vntrip.vn/v2-user/frontend/login/',
                method: 'POST',
                data: {
                    "email": login_email,
                    "password": login_password
                },
                beforeSend: function () {
                    $this.text("Đang đăng nhập...").prop('disable', true);
                },
                success: function (data) {
                    if (data.status === "success") {
                        VNT_BLOG.vntripGetUserInfo(data.data.access_token);
                    } else {
                        $this.text("Đăng nhập").prop('disable', false);
                        alert('Đăng nhập thất bại. Vui lòng thử lại!');
                    }
                },
                error: function (e) {
                    $this.text("Đăng nhập").prop('disable', false);
                    console.log(e);
                }
            });
        });

    },
    vntripLogout: function () {
        $('#user_logout').click(function () {
            localStorage.removeItem('__amplify__user');
            location.reload();
        });
    },
    vntripGetUserInfo: function (token) {
        $.ajax({
            url: 'https://micro-services.vntrip.vn/v2-user/frontend/users/profile/',
            headers: {
                'Authorization': `Bearer ${token}`,
            },
            beforeSend: function () {

            },
            success: function (response) {
                let user_info = response.data.filter(function (v, i) {
                    return v.type === "person";
                });

                let date = new Date();
                date.setDate(date.getDate() + 7);
                date.getTime();

                let user = user_info[0];
                let data_user = {
                    "data": {
                        "access_token": token,
                        "email": user.email,
                        "user_id": 26997,
                        "birthday": user.birthday,
                        "first_name": user.first_name,
                        "last_name": user.last_name,
                        "full_name": `${user.first_name} ${user.last_name}`,
                        "phone": user.phone,
                        "gender": user.gender,
                        "time": date,
                        "account_type": "user"
                    },
                    "expires": null
                };

                localStorage.setItem('__amplify__user', JSON.stringify(data_user));
                location.reload();

            },
            error: function (e) {
                console.log(e);
            }
        });
    },

    vntripGoogleOneTap: function () {
        window.onload = function () {
            google.accounts.id.initialize({
                client_id: '301462092120-bmkrma6siqqrkfoer19k0cthpn6224ie.apps.googleusercontent.com', // live
                // client_id: '1026187770118-6mi7pd7t0eqg47ru6qb3254ugdsel4ar.apps.googleusercontent.com', // test
                callback: handleCredentialResponse,
                cancel_on_tap_outside: false
            });
            google.accounts.id.prompt((notification) => {
                console.log("notification: ", notification);
            });
        };

        function handleCredentialResponse(data) {
            console.log("handleCredentialResponse: ", data)

            $.ajax({
                url: 'https://micro-services.vntrip.vn/v2-user/frontend/login/',
                method: 'POST',
                data: {
                    "google_id_token": data.credential,
                    "grant_type": "password",
                    "client_id": "16GuKzV8K1@92YcLg85uR5ku;peVriRZSn!1.UTh",
                    "client_secret": "TCuMmpT!EGz5UT7GE3D?s-ikA5i0sCV2pI7cFYqc!0c;z1oIyCeLsVb_ZDRdI7KOg4Pem7XKz4UU0yJ2K37I5;3Sp2UVw!tNK-ps4vaguqr09MopDwB_7larJWAmXHyv"
                },
                success: function (data) {
                    if (data.status === "success") {
                        VNT_BLOG.vntripGetUserInfo(data.data.access_token);
                    } else {
                        alert('Đăng nhập thất bại. Vui lòng thử lại!');
                    }
                },
                error: function (e) {
                    console.log(e);
                }
            });

        }
    },


    tabBookmark: function () {
        $('#tab_bookmark_hotel').click(function (e) {
            e.preventDefault();
            document.getElementById("list_bookmark").innerHTML = '';
            $('#tab_bookmark_hotel').addClass('active');
            $('#tab_bookmark_promotion').removeClass('active');

            VNT_BLOG.ajaxHotelBookmark();
        });

        $('#tab_bookmark_promotion').click(function (e) {
            e.preventDefault();
            document.getElementById("list_bookmark").innerHTML = '';
            $('#tab_bookmark_hotel').removeClass('active');
            $('#tab_bookmark_promotion').addClass('active');

            VNT_BLOG.ajaxLoadCouponBookmark();
        });
    },
    ajaxLoadCouponBookmark: function () {
        let cookie_post_ids = VNT_BLOG.getCookie('coupon_bookmark') || [];
        $.ajax({
            url: vntrip.ajax_url,
            data: {
                'action': 'get_coupon_bookmark',
                'cookie_post_ids': cookie_post_ids
            },
            beforeSend: function () {
                $('#list_bookmark_loading').show();
            },
            success: function (data) {
                console.log("data coupon: ", data);
                $('#list_bookmark_loading').hide();
                $('#list_bookmark').append(data.data);
            },
            error: function (e) {
                $('#list_bookmark_loading').hide();
                console.log(e);
            }
        });
    },
    ajaxHotelBookmark: function () {
        let cookie_hotel_ids = VNT_BLOG.getCookie('hotel_bookmark') || [];
        $.ajax({
            url: vntrip.ajax_url,
            data: {
                'action': 'get_hotel_bookmark',
                'cookie_hotel_ids': cookie_hotel_ids,
                'device': 'desktop'
            },
            beforeSend: function () {
                $('#list_bookmark_loading').show();
            },
            success: function (data) {
                console.log("data hotel: ", data);
                $('#list_bookmark_loading').hide();
                $('#list_bookmark').append(data.data);
            },
            error: function (e) {
                $('#list_bookmark_loading').hide();
                console.log(e);
            }
        });
    },

    fbShare: function (url) {
        var winTop = (screen.height / 2) - (350 / 2);
        var winLeft = (screen.width / 2) - (520 / 2);
        window.open('http://www.facebook.com/sharer.php?s=100&u=' + url, 'sharer', 'top=' + winTop + ',left=' + winLeft + ',toolbar=0,status=0,width=520,height=350');
    },

    sidebarCallbox: function () {
        $('.callBox__title').click(function () {
            $(this).toggleClass('rotate');
            $('.callBox__form').slideToggle(200);
        });

        $('#callbox_submit').click(function () {
            let phone_number = $('#call_box_phone_number').val();
            let full_name = $('#full_name').val();

            let a = full_name.indexOf(' ');
            let last_name = full_name.substring(0, a);
            let first_name = full_name.substring(a + 1);

            if (!phone_number) return alert('Vui lòng nhập số điện thoại!');

            // Call API here, wait api
            $.ajax({
                url: 'https://micro-services.vntrip.vn/v3-booking/general-ticket/hotline/',
                method: 'POST',
                data: {
                    "source": 13,
                    "phone": phone_number,
                    "first_name": first_name,
                    "lastname": last_name
                },
                beforeSend: function () {
                    $('#callbox_submit').text('Đang gửi yêu cầu...').prop('disable', true);
                    $('#callbox_status').hide();
                },
                success: function (data) {
                    if (data.status === 'success') {
                        $('#callbox_status').show();
                        $('#callbox_submit').text('Gửi').prop('disable', false);
                    }
                },
                error: function (e) {
                    console.log('error: ', e);
                }
            });
        });
    },

    slideOwlCarousel: function () {
        let owl_items = $('.owl-carousel').data('items') || 6;
        $('.owl-carousel').owlCarousel({
            loop: false,
            nav: true,
            items: owl_items,
            dots: false,
            lazyLoad: true,
            smartSpeed: 600,
            navText: [
                '<svg width="7" height="13" viewBox="0 0 7 13" fill="none" xmlns="http://www.w3.org/2000/svg">\n' +
                '    <path d="M6.50781 12.2656C6.45312 12.3203 6.39844 12.3477 6.28906 12.3477C6.20703 12.3477 6.125 12.3203 6.07031 12.2656L0.273438 6.46875C0.21875 6.41406 0.191406 6.33203 0.191406 6.25C0.191406 6.14062 0.21875 6.08594 0.273438 6.03125L6.07031 0.234375C6.125 0.179688 6.20703 0.152344 6.28906 0.152344C6.39844 0.152344 6.45313 0.179688 6.50781 0.234375L6.72656 0.453125C6.78125 0.507812 6.80859 0.5625 6.80859 0.671875C6.80859 0.753906 6.78125 0.835938 6.72656 0.917969L1.36719 6.25L6.72656 11.582C6.78125 11.6367 6.80859 11.7188 6.80859 11.8281C6.80859 11.9102 6.78125 11.9922 6.72656 12.0469L6.50781 12.2656Z" fill="black"/>\n' +
                '</svg>',
                '<svg width="7" height="13" viewBox="0 0 7 13" fill="none" xmlns="http://www.w3.org/2000/svg">\n' +
                '    <path d="M0.492188 0.734375C0.546875 0.679688 0.601562 0.652344 0.710938 0.652344C0.792969 0.652344 0.875 0.679688 0.929688 0.734375L6.72656 6.53125C6.78125 6.58594 6.80859 6.66797 6.80859 6.75C6.80859 6.85938 6.78125 6.91406 6.72656 6.96875L0.929688 12.7656C0.875 12.8203 0.792969 12.8477 0.710938 12.8477C0.601562 12.8477 0.546875 12.8203 0.492188 12.7656L0.273438 12.5469C0.21875 12.4922 0.191406 12.4375 0.191406 12.3281C0.191406 12.2461 0.21875 12.1641 0.273438 12.082L5.63281 6.75L0.273438 1.41797C0.21875 1.36328 0.191406 1.28125 0.191406 1.17188C0.191406 1.08984 0.21875 1.00781 0.273438 0.953125L0.492188 0.734375Z" fill="black"/>\n' +
                '</svg>\n'
            ],
        })
    },

    clickInsertComment: function () {
        $('#commentform').submit(function (event) {
            event.preventDefault();
            console.log('insert comment...')

            VNT_BLOG.ajaxInsertComment()

        });
    },

    ajaxInsertComment: function () {
        const comment_text = $('#comment').val()
        let user = localStorage.getItem('__amplify__user');
        user = JSON.parse(user);

        console.log('data: ', {
            'comment_text': comment_text,
            'user': user,
        })

        if (user) {
            if (user?.data) {
                const button = $('#submit'), // submit button
                    respond = $('#respond'), // comment form container
                    commentlist = $('.comment-list'), // comment list container
                    cancelreplylink = $('#cancel-comment-reply-link'),
                    post_id = $('#post_id').val();

                // ajax request
                $.ajax({
                    type: 'POST',
                    url: vntrip.ajax_url,
                    data: `comment=${comment_text}&action=ajaxcomments&author=${user.data.full_name}&email=${user.data.email}&comment_post_ID=${post_id}`, // send form data + action parameter
                    beforeSend: function (xhr) {
                        button.text('Loading...').prop('disabled', true);
                    },
                    error: function (request, status, error) {
                        if (status == 500) {
                            alert('Error while adding comment');
                        } else if (status == 'timeout') {
                            alert('Error: Server doesn\'t respond.');
                        } else {
                            // process WordPress errors
                            var wpErrorHtml = request.responseText.split("<p>"),
                                wpErrorStr = wpErrorHtml[1].split("</p>");

                            alert(wpErrorStr[0]);
                        }
                    },
                    success: function (addedCommentHTML) {
                        // if this post already has comments
                        if (commentlist.length > 0) {

                            // if in reply to another comment
                            if (respond.parent().hasClass('comment')) {

                                // if the other replies exist
                                if (respond.parent().children('.children').length) {
                                    respond.parent().children('.children').prepend(addedCommentHTML);
                                } else {
                                    // if no replies, add <ol class="children">
                                    addedCommentHTML = '<ol class="children">' + addedCommentHTML + '</ol>';
                                    respond.parent().prepend(addedCommentHTML);
                                }
                                // close respond form
                                cancelreplylink.trigger("click");
                            } else {
                                // simple comment
                                commentlist.prepend(addedCommentHTML);
                            }
                        } else {
                            // if no comments yet
                            addedCommentHTML = '<ol class="comment-list">' + addedCommentHTML + '</ol>';
                            respond.before($(addedCommentHTML));
                        }
                        // clear textarea field
                        $('#comment').val('');
                    },
                    complete: function () {
                        // what to do after a comment has been added
                        button.removeClass('loadingform').text('Gửi').prop('disabled', false);
                    }
                });
            } else {
                alert('Vui lòng đăng nhập để gửi bình luận!')
            }
        } else {
            alert('Vui lòng đăng nhập để gửi bình luận!')
        }

    },

};

VNT_BLOG.init();